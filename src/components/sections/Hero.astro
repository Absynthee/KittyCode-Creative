---
import { Image } from "astro:assets";
import Button from "@/components/ui/Button.astro";
import Input from "../ui/Input.astro";

import Kitty from "@/assets/images/kitty.gif";
import { ChevronLeft, EllipsisVertical } from "@lucide/astro";

interface Props {
  name: string;
  role?: string;
  tagline?: string;
  bio?: string;
  primaryCTA?: {
    text: string;
    href: string;
    variant?: "default" | "primary" | "secondary" | "outline" | "ghost";
  };
  secondaryCTA?: {
    text: string;
    href: string;
    variant?: "default" | "primary" | "secondary" | "outline" | "ghost";
  };
  class?: string;
}

const { name, role, bio, primaryCTA, secondaryCTA } = Astro.props;
---

<script>
  document.addEventListener("DOMContentLoaded", () => {
    import("@/lib/sparkly-text.js");
  });

  // Mouse-follow rotation script for phone container
  function initPhoneRotation(): void {
    const phone = document.querySelector<HTMLElement>(".phone-container");
    const heroContainer = document.querySelector<HTMLElement>(".hero");

    if (!phone) {
      console.warn("Phone container element not found");
      return;
    }

    if (!heroContainer) {
      console.warn("Hero element not found");
      return;
    }

    // Remove animation after it completes to prevent interference
    setTimeout(() => {
      phone.style.animation = "none";
      phone.style.opacity = "1";
    }, 4000);

    // Ensure smooth transitions are enabled
    phone.style.transition = "transform 0.3s ease-out";

    // Only listen to mousemove when inside hero container
    heroContainer.addEventListener("mouseenter", () => {
      document.addEventListener("mousemove", handleMouseMove);
    });

    // Reset and stop listening when mouse leaves hero container
    heroContainer.addEventListener("mouseleave", () => {
      document.removeEventListener("mousemove", handleMouseMove);
      resetPhoneRotation(phone);
    });

    function handleMouseMove(e: MouseEvent) {
      if (phone && heroContainer) {
        rotateElement(e, phone, heroContainer);
      }
    }
  }

  function rotateElement(
    event: MouseEvent,
    element: HTMLElement,
    heroContainer: HTMLElement
  ): void {
    // Get mouse position
    const x = event.clientX;
    const y = event.clientY;

    const heroRect = heroContainer.getBoundingClientRect();

    // Check if mouse is actually within hero container bounds
    if (
      x < heroRect.left ||
      x > heroRect.right ||
      y < heroRect.top ||
      y > heroRect.bottom
    ) {
      resetPhoneRotation(element);
      return;
    }

    const phoneRect = element.getBoundingClientRect();
    const middleX = phoneRect.left + phoneRect.width / 2;
    const middleY = phoneRect.top + phoneRect.height / 2;

    const offsetX = ((x - middleX) / middleX) * 20;
    const offsetY = ((y - middleY) / middleY) * 10;

    // Set CSS custom properties for rotation
    element.style.setProperty("--rotateX", `${offsetX}deg`);
    element.style.setProperty("--rotateY", `${-offsetY}deg`);
  }

  function resetPhoneRotation(element: HTMLElement): void {
    // Use requestAnimationFrame to ensure smooth transition
    requestAnimationFrame(() => {
      // Reset to center position with smooth transition
      element.style.setProperty("--rotateX", "0deg");
      element.style.setProperty("--rotateY", "0deg");
    });
  }

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", initPhoneRotation);
</script>

<section id="hero" class="hero hero--fullwidth" aria-labelledby="hero-title">
  <div class="hero-container">
    <div class="hero-content">
      <div class="role-container">
        <sparkly-text
          number-of-sparkles="5"
          style="--sparkly-text-color: color-mix(in srgb, currentColor, var(--primary) 100%);"
        >
          <mark class="hero-role">{role}</mark>
        </sparkly-text>
      </div>

      <h1 class="hero-name" id="hero-title">{name}</h1>

      <p class="hero-bio">{bio}</p>

      {
        (primaryCTA || secondaryCTA) && (
          <div class="hero-buttons">
            {primaryCTA && (
              <Button
                href={primaryCTA.href}
                variant={primaryCTA.variant || "primary"}
                size="large"
              >
                {primaryCTA.text}
              </Button>
            )}

            {secondaryCTA && (
              <Button
                href={secondaryCTA.href}
                variant={secondaryCTA.variant || "outline"}
                size="large"
              >
                {secondaryCTA.text}
              </Button>
            )}
          </div>
        )
      }
    </div>
    <div class="phone-container">
      <div class="phone">
        <div class="phone-menu">
          <ChevronLeft class="menu-back-icon" size={28} />
          <div class="contact-info-container">
            <img src="/favicon.png" class="menu-avatar" />
            <div class="contact-info">
              <p class="name">KittyCode Creative</p>
              <p class="role">Available to Code</p>
            </div>
          </div>
          <EllipsisVertical class="menu-more-icon" size={28} />
        </div>
        <div class="chat-container">
          <div class="chat-message chat-user-2">
            Hey KittyCode, we need a new website!
          </div>
          <div class="chat-message chat-user-2">
            Are you available to take us on?
          </div>
          <div class="chat-message chat-user-1 chat-sticker">
            <Image
              class="typing-cat"
              src={Kitty}
              alt="Hero Background"
              height={100}
              width={100}
              loading="eager"
            />
          </div>
          <div class="chat-message chat-user-1">Hi there!</div>
          <div class="chat-message chat-user-1">
            Sure thing! We can create a bespoke website tailored to your needs.
          </div>
          <div class="chat-message chat-user-1">
            If you'd like to get a head-start, you can fill in our questionnaire
            form.
          </div>
          <div class="chat-message chat-user-1 chat-phone-link">
            Here's a link for you:
            <a class="phone-link" href="services/website-questionnaire"
              >kittycodecreative.com&sol; website-questionnaire</a
            >
          </div>

          <div class="chat-message chat-user-2">
            Awesome. Thank you, KittyCode! üòç
          </div>
        </div>
        <Input
          class="send-message-container"
          type="text"
          placeholder="Type your message..."
          aria-label="Type your message"
          variant="primary"
        />
      </div>
    </div>
  </div>

  <style>
    .hero {
      position: relative;
      overflow: hidden;
      background: var(--background);
      background-image: conic-gradient(
        from 255deg at 50% 0% in oklab,
        var(--secondary),
        var(--background),
        var(--background),
        var(--secondary)
      );
      background-blend-mode: color-dodge;
      min-block-size: 100dvh;
      display: grid;
      place-items: center;
    }

    .hero--fullwidth {
      display: flex;
      margin: 0 auto;
      width: 100%;
      min-height: calc(100vh - 332px);
    }

    .typing-cat {
      place-self: center;
      animation: slideInDown 0.8s ease-out 0.2s both;
      user-select: none;
    }

    .hero-container {
      display: grid;
      grid-auto-flow: column;
      grid-template-columns: 2fr 1fr;
      width: 100%;
      max-width: 1800px;
      align-items: center;
      margin: 0 auto;
      padding: 6rem 2rem;
      gap: 2rem;
    }

    .hero-content {
      display: flex;
      flex-direction: column;
      margin: 0 auto;
      max-width: 1000px;
      transition: all 0.3s ease-in-out;
    }

    .role-container {
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    mark {
      background-color: var(--primary-absolute);
      font-weight: 600;
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
    }

    .hero-name {
      color: var(--foreground);
      font-size: calc(var(--step-4) * 2);
      background: linear-gradient(
        135deg,
        var(--secondary) 0%,
        var(--primary-absolute) 30%,
        var(--primary-absolute) 60%,
        var(--secondary) 100%
      );
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 300% 300%;
      padding-top: 1rem;
      padding-bottom: 2rem;
      transform: perspective(5000px) rotateY(var(--rotateX))
        rotateX(var(--rotateY));
      animation:
        gradientShift 20s ease-in-out infinite,
        slideInUp 0.8s ease-out 0.3s both;
    }

    .hero-tagline {
      font-size: var(--step-1);
      font-weight: 500;
      color: hsl(from var(--foreground) h s l / 0.8);
      line-height: 1.4;
      max-width: 62ch;
      text-wrap: balance;
      animation: fadeInUp 0.8s ease-out 0.6s both;
      padding-bottom: 2rem;
    }

    .hero-bio {
      font-size: var(--step-0);
      color: hsl(from var(--foreground) h s l / 0.8);
      max-width: 78ch;
      padding-bottom: 2rem;
      animation: fadeInUp 0.8s ease-out 0.8s both;
    }

    .hero-buttons {
      display: flex;
      /* gap: 2rem; */
      flex-wrap: wrap;
      animation: fadeInUp 0.8s ease-out 1.4s both;
    }

    .btn:nth-child(1) {
      margin-inline-end: 2rem;
    }

    .phone-container {
      --rotateX: 0deg;
      --rotateY: 0deg;
      opacity: 0;
      width: 25rem;
      aspect-ratio: 9 / 18.4;
      outline: 1rem solid light-dark(var(--foreground), var(--card));
      border-radius: 2rem;
      line-height: 1.2;
      z-index: 10;
      scale: 95%;
      place-self: center;
      /* transition: all 0.3s ease-in-out; */
      transform-style: preserve-3d;
      transform: perspective(2000px) rotateY(var(--rotateX))
        rotateX(var(--rotateY));
      animation: fadeInLeft 2s ease-out 1.8s forwards;
    }

    .phone-container::before {
      content: "";
      position: absolute;
      z-index: -1;
      inset: 0.75rem;
      border-radius: inherit;
      background: var(--background);
      z-index: -1;
      transform: translateZ(-50px);
      filter: blur(15px);
      opacity: 0.5;
    }

    .phone-container::after {
      content: "";
      position: absolute;
      z-index: -2;
      inset: -1rem;
      border-radius: inherit;
      background: light-dark(var(--foreground), var(--card));
      transform: translateZ(-40px);
    }

    .phone {
      display: block;
      position: relative;
      background-color: var(--background);
      height: 100%;
      width: 100%;
      border-radius: 1rem;
      z-index: -1;
    }

    .phone-menu {
      display: flex;
      position: relative;
      align-items: center;
      justify-content: space-evenly;
      color: var(--white);
      border-radius: 1rem 1rem 0 0;
      height: 5rem;
      width: 100%;
      background: linear-gradient(
        -90deg,
        var(--primary),
        var(--primary-absolute)
      );
      z-index: -1;
      margin-bottom: 1rem;
    }

    .menu-avatar {
      height: 40px;
      width: 40px;
      aspect-ratio: 1 / 1;
      margin-inline-end: 1rem;
    }

    .contact-info-container {
      display: flex;
      user-select: none;
    }

    .contact-info {
      min-width: 180px;
    }

    p.name {
      font-size: 1rem;
      font-weight: 700;
      line-height: clamp(130%, 0.9vw, 140%);
      color: var(--background);
    }

    p.role {
      font-size: 0.75rem;
      line-height: 1;
      color: var(--background);
    }

    .chat-container {
      position: relative;
      display: grid;
      padding-inline: 1rem;
    }

    .chat-message {
      animation: fadeIn 0.5s ease-in-out both;

      &:nth-child(1) {
        animation-delay: 2.5s;
      }
      &:nth-child(2) {
        animation-delay: 3.5s;
      }
      &:nth-child(3) {
        animation-delay: 5s;
      }
      &:nth-child(4) {
        animation-delay: 6s;
      }
      &:nth-child(5) {
        animation-delay: 7s;
      }
      &:nth-child(6) {
        animation-delay: 8s;
      }
      &:nth-child(7) {
        animation-delay: 9s;
      }
      &:nth-child(8) {
        animation-delay: 11s;
        position: relative;

        &::after {
          content: "‚ù§";
          position: absolute;
          display: grid;
          bottom: -10px;
          left: -10px;
          width: 32px;
          height: 32px;
          border-radius: 12px;
          color: var(--primary-absolute);
          background-color: var(--background);
          outline: 1px solid var(--background);
          place-items: center;
          font-size: var(--step-0);
          animation: fadeIn 0.5s ease-in-out both;
          animation-delay: 13s;
        }
      }
    }

    .chat-user-1 {
      display: flex;
      justify-content: start;
      text-align: left;
      width: fit-content;
      max-width: 25ch;
      margin-block-end: var(--space-2xs);
      padding-block: var(--space-2xs);
      padding-inline: var(--space-2xs);
      background-color: var(--primary-background);
      border-radius: 12px 12px 12px 2px;
      color: var(--foreground);
    }

    .chat-sticker {
      background-color: var(--transparent);
    }

    .chat-phone-link {
      display: block;
    }

    .phone-link {
      font-size: inherit;
      color: inherit;
      text-decoration: underline;
      font-weight: 600;
    }

    .phone-link:hover {
      color: var(--white);
    }

    .chat-user-2 {
      position: relative;
      display: flex;
      text-align: right;
      width: fit-content;
      max-width: 25ch;
      margin-block-end: var(--space-2xs);
      padding-block: var(--space-2xs);
      padding-inline: var(--space-2xs);
      background-color: var(--accent-3-background);
      color: var(--foreground);
      border-radius: 12px 12px 2px 12px;
      place-self: end;
    }

    .send-message-container {
      position: absolute;
      display: flex;
      margin: auto;
      width: 90%;
      margin-inline: 5%;
      padding-inline: 1rem;
      align-items: center;
      bottom: 1rem;
    }

    @keyframes gradientShift {
      0%,
      100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      0% {
        opacity: 0;
        transform: scale(0.1);
      }

      85% {
        opacity: 1;
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes shimmer {
      0%,
      100% {
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
    }

    @media screen and (max-width: 1100px) {
      .hero-name {
        font-size: var(--step-6);
      }

      .btn--large {
        min-width: 10em;
      }

      .phone-container {
        scale: 90%;
      }
    }

    @media screen and (max-width: 910px) {
      .hero-name {
        font-size: var(--step-5);
      }

      .hero-buttons {
        align-items: center;
      }

      .btn:nth-child(1) {
        margin-inline-end: 1rem;
      }

      .btn--large {
        min-width: 12em;
      }

      .phone-container {
        scale: 80%;
      }
    }

    @media screen and (max-width: 840px) {
      .hero-container {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .hero-buttons {
        align-items: center;
        justify-content: center;
      }

      .btn--large {
        min-width: 12em;
      }

      .phone-container {
        display: none;
      }
    }
  </style>
</section>
